<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
   음료목록
   <div th:if="${not #lists.isEmpty(drinks)}">
   
   <table border="2px">
   	<thead>
   		<th>이미지</th>
   		<th>이름</th>
   		<th>가격</th>
   		<th>재고</th>
   		<th>상태</th>
   		<th>삭제</th>
   		<th>이름수정</th>
   		<th>가격수정</th>
   		<th>재고수정</th>
   		<th>이미지수정</th>
   	</thead>
   	<tbody>
   		<tr th:each="d: ${drinks}">
   			<td id="dImg" data-th-dImgSrc="${d.dImgSrc}" data-th-dImgName="${d.dImgName}">
   				<img th:src="@{|/drinkImages/${d.dImgName}|}" width=30 height=30/>
   			</td>
   			<td id="dName" data-th-drinkId="${d.drinkId}" th:text="${d.dName}"></td>
   			<td id="dPrice" th:text="${d.dPrice}"></td>
   			<td id="dStock" th:text="${d.dStock}"></td>
   			<td id="stat" data-th-statId="${d.statId.statId}" th:text="${d.statId.statName}"></td>
   			<td><button id="delete">삭제</button></td>
   			<td><button id="putName">이름수정</button></td>
   			<td><button id="putPrice">가격수정</button></td>
   			<td><button id="putStock">재고수정</button></td>
   			<td>
   				<form th:action="@{/api/putDrinkImg}" method="POST" enctype="multipart/form-data">
   					<input name="drinkId" type="hidden" th:value="${d.drinkId}">
   					<input name="currentdImgSrc" type="hidden" th:value="${d.dImgSrc}">
   					<input name="newdImg" type="file">
   					<input id="putImg" value="이미지 수정" type="submit"></button>
   				</form>
   			</td>
   		</tr>
   	</tbody>
   </table>
  
  <a href="/admin/test">새 상품 등록하러가기</a>
  
  </div>
  
 <div th:unless="${not #lists.isEmpty(drinks)}">
	<h2>현재 등록된 상품이 없습니다.</h2>
	<a href="/admin/test">등록하러가기</a>
</div>
  
  
  
  
  
 <script th:inline="javascript">
  	$(()=>{
		
		// 상품 삭제
		$("#delete").on("click", ()=>{
			if(confirm("선택한 상품을 삭제하시겠습니까?") == false) {
				alert("취소되었습니다.")
			} else {
		
				var drinkId = $("#dName").attr("drinkId");
				var dImgSrc = $("#dImg").attr("dImgSrc");
				var obj = {
					drinkId : drinkId,
					dImgSrc : dImgSrc
				}
				var data = JSON.stringify(obj);
				
				const url = "/api/deleteDrink";
				
				const csrfToken=/*[[${_csrf.token}]]*/ null;
				const csrfHeader=/*[[${_csrf.headerName}]]*/ null;
			
				$.ajax({
					url:url,
					type:"delete",
					contentType:'application/json',
					data:data,
					beforeSend:function(xhr){ xhr.setRequestHeader(csrfHeader, csrfToken);}
				})
				.done((result)=>{
					if(result.result == "ok") {
						console.log(result);
						alert("삭제가 완료되었습니다.")
						location.href="/admin/testCrud";
					} else {
						console.log(result);
						alert("삭제를 실패하였습니다. 해당 상품이 존재하지 않습니다.")
					}
				})
				.fail((err)=>{
					alert("ERR : 삭제실패")
				});
						
			}		
			
		});
		
		
		// 상품 이름 수정
		$("#putName").on("click", ()=>{
			var nameInput = prompt("해당 상품의 새로운 이름을 입력해주세요.");
			if(nameInput == "" || nameInput == $("#dName").text()) {
				alert("공백값이나 동일한 이름은 입력할 수 없습니다.");
			} else if(nameInput == null) {
				alert("취소되었습니다.");
			} else{
				
				var drinkId = $("#dName").attr("drinkId");
				var dName = $("#dName").text();
				
				var obj = {
					drinkId : drinkId,
					newdName : nameInput
				}
				var data = JSON.stringify(obj);
				
				const url = "/api/putDrinkName";
				const csrfToken=/*[[${_csrf.token}]]*/ null;
				const csrfHeader=/*[[${_csrf.headerName}]]*/ null;
				
				$.ajax({
						url:url,
						type:"put",
						contentType:'application/json',
						data:data,
						beforeSend:function(xhr){ xhr.setRequestHeader(csrfHeader, csrfToken);}
				})
				.done((result)=> {
					console.log(result);
					if(result.result == "ok") {
						alert("상품 이름 변경이 완료되었습니다.");
						location.href="/admin/testCrud"
					} else {
						alert("이름 변경을 실패하였습니다.");
					}
					
				})
				.fail((err)=> {
					console.log(err);
					alert("ERR : 변경실패")
				});
				
			}		
			
		});
		
		
		//상품 가격 변경
		$("#putPrice").on("click", ()=>{
			var priceInput = prompt("해당 상품의 새로운 가격을 입력해주세요.");
			if(priceInput == "" || priceInput <= 0 || priceInput == Number($("#dPrice").text())) {
				alert("공백값이나 0원 미만 또는 동일한 가격은 입력할 수 없습니다.");
			} else {
				
				var drinkId = $("#dName").attr("drinkId");
				var dPrice = Number($("#dPrice").text());
				
				var obj = {
					drinkId : drinkId,
					newdPrice : priceInput
				}
				var data = JSON.stringify(obj);
				
				const url = "/api/putDrinkPrice";
				const csrfToken=/*[[${_csrf.token}]]*/ null;
				const csrfHeader=/*[[${_csrf.headerName}]]*/ null;
				
				$.ajax({
						url:url,
						type:"put",
						contentType:'application/json',
						data:data,
						beforeSend:function(xhr){ xhr.setRequestHeader(csrfHeader, csrfToken);}
				})
				.done((result)=> {
					console.log(result);
					if(result.result == "ok") {
						alert("상품 가격 변경이 완료되었습니다.");
						location.href="/admin/testCrud"
					} else {
						alert("가격 변경을 실패하였습니다.");
					}
					
				})
				.fail((err)=> {
					console.log(err);
					alert("ERR : 변경실패")
				});
				
			}		
			
		});		
		
		
		//상품 재고 변경
		$("#putStock").on("click", ()=>{
			var stockInput = prompt("해당 상품의 재고를 입력해주세요.");
			if(stockInput == "" || stockInput < 0) {
				alert("공백값이나 0개 미만은 입력할 수 없습니다.");
			} else {
				
				var drinkId = $("#dName").attr("drinkId");
				var dStock = Number($("#dStock").text());
				
				var obj = {
					drinkId : drinkId,
					newdStock : stockInput
				}
				var data = JSON.stringify(obj);
				
				const url = "/api/putDrinkStock";
				const csrfToken=/*[[${_csrf.token}]]*/ null;
				const csrfHeader=/*[[${_csrf.headerName}]]*/ null;
				
				$.ajax({
						url:url,
						type:"put",
						contentType:'application/json',
						data:data,
						beforeSend:function(xhr){ xhr.setRequestHeader(csrfHeader, csrfToken);}
				})
				.done((result)=> {
					console.log(result);
					if(result.result == "ok") {
						alert("상품 재고 변경이 완료되었습니다.");
						location.href="/admin/testCrud"
					} else {
						alert("재고 변경을 실패하였습니다.");
					}
					
				})
				.fail((err)=> {
					console.log(err);
					alert("ERR : 변경실패")
				});
				
			}		
			
		});			
		
				
		
	});
  
  </script>
</body>
</html>